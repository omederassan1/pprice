<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø¨Ø­Ø« Ø§Ù„Ù…ÙˆØ§Ø¯</title>

<style>
body {
  font-family: 'Segoe UI', Tahoma;
  padding: 20px;
  background: #f0f2f5;
}
.container {
  max-width: 800px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,0,0,.1);
}
h1,h2 { text-align:center; }

.search-box {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
input {
  padding: 15px;
  font-size: 18px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}
button {
  padding: 14px 25px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  background: #ff0000;
  color: #fff;
  cursor: pointer;
}
button:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.price-box {
  display: inline-block;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
}
.wholesale {
  border: 2px solid #dc3545;
  color: #dc3545;
  background: #fff5f5;
}
.retail {
  border: 2px solid #28a745;
  color: #28a745;
  background: #f4fff7;
}
.plumber {
  border: 2px solid #ffc107;
  color: #856404;
  background: #fff8e1;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}
th { background: #f0f0f0; }

.loading { font-weight: bold; }
.error { color: red; font-weight: bold; }

.order-section {
  margin-top: 25px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #f8f9fa;
}
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
<div class="container">
  <h1>Ø´Ø±ÙƒØ© Ø£ÙˆÙ…ÛŒØ¯ÙŠ Ø±Ø§Ø³Ø§Ù†-Ø¨ØºØ¯Ø§Ø¯</h1>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <div class="buttons">
      <button id="searchButton">ğŸ” Ø¨Ø­Ø«</button>
      <button id="scanButton">ğŸ“·</button>
    </div>
  </div>

  <div id="cameraContainer"></div>
  <div id="result"></div>

  <div class="order-section" id="orderSection" style="display:none">
    <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <input type="text" id="itemCode" readonly placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯Ø©">
    <input type="number" id="quantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
    <input type="text" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" oninput="formatPrice(this)">
    <button id="submitOrder">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  </div>
</div>

<script>
/* ===================== API ===================== */
const PRICE_API_URL = 'https://script.google.com/macros/s/AKfycbwlxKnBrvLBFlZEiP6auRQdI0laM1TuGeNWEGh0th3PvjJv5VYFzW1bTD_qxGvypb9F/exec';
const STOCK_API_URL = 'https://script.google.com/macros/s/AKfycbxOetGhckv30w3hfbPLLFUxBOT6bOSSPrDNgqdqaER2vqMXKYb7Bvz1eDsJY8AiiCuYKg/exec';
const ORDER_API_URL = 'https://script.google.com/macros/s/AKfycbxX5hFAPycU6uQsQbxdquc44WKyuN8BUnIHq6JQF8iHPovWPH4Vjul4ye9lsPqung/exec';

/* ===================== Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ===================== */
async function fetchPrices(code) {
  const res = await fetch(`${PRICE_API_URL}?code=${code}`);
  return await res.json();
}

async function fetchStock(code) {
  const res = await fetch(`${STOCK_API_URL}?code=${code}`);
  return await res.json();
}

function formatPrice(input) {
  let v = input.value.replace(/[^\d]/g,'');
  input.value = v ? Number(v).toLocaleString('en-US') : '';
}

/* ===================== Ø§Ù„Ø¨Ø­Ø« ===================== */
async function searchAll() {
  const code = searchInput.value.trim();
  if (!code) return;

  result.innerHTML = "<p class='loading'>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>";
  orderSection.style.display = "none";

  const priceData = await fetchPrices(code);

  if (!priceData || priceData.status !== 'success') {
    result.innerHTML = "<p class='error'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø±</p>";
    return;
  }

  result.innerHTML = `
    <h3>${priceData.name}</h3>
    <p>Ø¬Ù…Ù„Ø© Ø¨ØºØ¯Ø§Ø¯:
      <span class="price-box wholesale">${(priceData.wholesale||0).toLocaleString('en-US')}</span>
    </p>
    <p>Ø¬Ù…Ù„Ø© Ù…Ø¹Ø±Ø¶:
      <span class="price-box retail">${(priceData.retail||0).toLocaleString('en-US')}</span>
    </p>
    <p>Ø¬Ù…Ù„Ø© Ø³Ø¨Ø§Ùƒ:
      <span class="price-box plumber">${(priceData.plumber||0).toLocaleString('en-US')}</span>
    </p>
  `;

  itemCode.value = code;
  quantity.value = "";
  price.value = "";
  orderSection.style.display = "block";

  const stock = await fetchStock(code);
  const baghdad = stock?.find(s => s.warehouse.includes("Ø¨ØºØ¯Ø§Ø¯"));
  if (baghdad) {
    result.innerHTML += `
      <h4>Ù…Ø®Ø²ÙˆÙ† Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨ØºØ¯Ø§Ø¯</h4>
      <table>
        <tr><th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr>
        <tr><td>Ø¨ØºØ¯Ø§Ø¯</td><td>${Number(baghdad.balance).toLocaleString('en-US')}</td></tr>
      </table>
    `;
  } else {
    result.innerHTML += "<p class='error'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙÙŠ Ø¨ØºØ¯Ø§Ø¯</p>";
  }
}

/* ===================== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===================== */
let html5QrCode;

function stopCamera() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      cameraContainer.innerHTML = "";
    }).catch(() => {});
  }
}

async function startBarcodeScanner() {
  cameraContainer.innerHTML = "";
  html5QrCode = new Html5Qrcode("cameraContainer");

  const devices = await Html5Qrcode.getCameras();
  if (!devices.length) {
    cameraContainer.innerHTML = "<p class='error'>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§</p>";
    return;
  }

  const camera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

  html5QrCode.start(
    camera.id,
    { fps: 10, qrbox: 250 },
    decodedText => {
      searchInput.value = decodedText;
      stopCamera();
      searchAll();
    }
  );
}

/* ===================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ===================== */
submitOrder.onclick = async function () {
  if (this.disabled) return;

  if (!quantity.value || !price.value) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø±");
    return;
  }

  this.disabled = true;
  this.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";
  this.style.background = "#6c757d";

  try {
    const formData = new FormData();
    formData.append("code", itemCode.value);
    formData.append("quantity", quantity.value);
    formData.append("price", price.value.replace(/,/g,''));

    await fetch(ORDER_API_URL, {
      method: "POST",
      body: formData
    });

    // âœ… Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    this.innerText = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
    this.style.background = "#28a745";

    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù…
    setTimeout(() => {
      searchInput.value = "";
      itemCode.value = "";
      quantity.value = "";
      price.value = "";
      orderSection.style.display = "none";
      result.innerHTML = "";
      this.disabled = false;
      this.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      this.style.background = "#ff0000";
    }, 2000);

  } catch (e) {
    this.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    this.style.background = "#dc3545";
    this.disabled = false;
  }
};

/* ===================== Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===================== */
searchButton.onclick = searchAll;
scanButton.onclick = startBarcodeScanner;
</script>

</body>
</html>
